<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anime List</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="/style.css">
</head>
<body class="container mt-4">
    <h1 class="text-center">boydaihungst Anime List</h1>
    <div class="row">
        <% data.forEach(anime => { %>
            <div class="col-md-2 mb-3">
                <div class="card" id="<%= anime.id %>">
                    <img src="<%= anime.images.portrait %>" class="card-img-top" alt="<%= anime.title %>">
                    <div class="card-body">
                        <h5 class="card-title"><%= anime.title %></h5>
                        <div class="dropdown">
                            <button class="btn btn-primary dropdown-toggle" type="button" id="dropdownMenuButton-<%= anime.id %>" data-bs-toggle="dropdown" aria-expanded="false">
                                Chọn Season
                            </button>
                            <ul class="dropdown-menu season-dropdown" aria-labelledby="dropdownMenuButton-<%= anime.id %>" data-series-id="<%= anime.id %>">
                                <li><a class="dropdown-item text-muted">Đang tải...</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        <% }); %>
    </div>

    <!-- Modal Chi Tiết -->
    <div class="modal fade" id="animeModal" tabindex="-1" aria-labelledby="animeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="animeTitle"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <img id="animeImage" class="img-fluid w-10 mb-3" alt="Anime Image">
                    <h5>Danh sách tập</h5>
                    <ul id="episodeList" class="list-group"></ul>
                    
                    
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
    // Xử lý khi click vào dropdown để load seasons
    document.addEventListener("show.bs.dropdown", function (event) {
        const dropdown = event.target.nextElementSibling;
        if (dropdown && dropdown.classList.contains("season-dropdown")) {
            const seriesId = dropdown.getAttribute("data-series-id");
            
            // Kiểm tra nếu đã load seasons rồi thì không load lại
            if (dropdown.querySelector(".dropdown-item:not(.text-muted)")) {
                return;
            }

            // Load seasons từ API
            axios.get(`/api/seasons?series_id=${seriesId}`)
                .then(response => {
                    const seasons = response.data;
                    dropdown.innerHTML = ""; // Xóa nội dung "Đang tải..."

                    if (seasons.length === 0) {
                        dropdown.innerHTML = '<li><a class="dropdown-item text-muted">Không có season nào</a></li>';
                        return;
                    }

                    seasons.forEach(season => {
                        const seasonItem = document.createElement("li");
                        seasonItem.innerHTML = `
                            <a class="dropdown-item season-item" href="#" data-season-id="${season.id}" data-season-title="${season.title}">
                                ${season.title}
                            </a>
                        `;
                        dropdown.appendChild(seasonItem);
                    });
                })
                .catch(error => {
                    console.error("Lỗi khi lấy danh sách seasons:", error);
                    dropdown.innerHTML = '<li><a class="dropdown-item text-danger">Lỗi tải dữ liệu</a></li>';
                });
        }
    });

    // Xử lý khi click vào một season item
    document.addEventListener("click", function (event) {
        if (event.target.classList.contains("season-item")) {
            event.preventDefault();
            const seasonId = event.target.getAttribute("data-season-id");
            const seasonTitle = event.target.getAttribute("data-season-title");

            // Cập nhật title modal
            document.getElementById("animeTitle").textContent = seasonTitle;
            
            // Lấy thông tin season để hiển thị ảnh
            const seriesId = event.target.closest(".season-dropdown").getAttribute("data-series-id");
            axios.get(`/api/seasons?series_id=${seriesId}`)
                .then(response => {
                    const seasons = response.data;
                    const currentSeason = seasons.find(s => s.id == seasonId);
                    if (currentSeason) {
                        document.getElementById("animeImage").src = currentSeason.images.portrait || currentSeason.images.poster;
                    }
                })
                .catch(error => console.error("Lỗi khi lấy thông tin season:", error));

            // Gọi API lấy danh sách tập
            axios.get(`/api/season?season_id=${seasonId}`)
                .then(episodeResponse => {
                    const episodeList = document.getElementById("episodeList");
                    episodeList.innerHTML = ""; // Xóa nội dung cũ

                    if (episodeResponse.data.results.length === 0) {
                        episodeList.innerHTML = '<li class="list-group-item text-muted">Không có tập nào</li>';
                        return;
                    }

                    episodeResponse.data.results.forEach(episode => {
                        const episodeItem = document.createElement("li");
                        episodeItem.classList.add("list-group-item");
                        episodeItem.innerHTML = `
                            <img src="${episode.image}" alt="${episode.title}" class="img-thumbnail me-2" width="100">
                            <a href="${episode.vietsub}" target="_blank"> <strong>${episode.subtitle} Vie</strong> </a>
                        `;
                        episodeList.appendChild(episodeItem);
                    });
                })
                .catch(error => {
                    console.error("Lỗi khi lấy danh sách tập:", error);
                    const episodeList = document.getElementById("episodeList");
                    episodeList.innerHTML = '<li class="list-group-item text-danger">Lỗi tải danh sách tập</li>';
                });

            // Hiển thị modal
            new bootstrap.Modal(document.getElementById("animeModal")).show();
        }
    });
});
    </script>
    
</body>
</html>
